## 1 AWS를 이용한 운영 서버 환경 구축

#### 1 운영서버와 AWS

- 운영 서버 : 실제 사용자들이 서비스 사용하는 서버

- 운영 서버 관리 3단계 : 환경 구성, 코드 배포, 모니터링

- 운영 서버 환경 구성으로 AWS(amazone web service ) 클라우드 서비스 사용을 공부할 것임

  

#### 2 운영 서버 환경의 구성

##### 운영 서버 아키텍처

- 단일 서버 

  - 서비스 장애에 취약: 서버가 같은 자원을 공유하니까
  - 서비스 자원 효율적으로 사용 어려움
  - 보안성 낮음: 웹 애플리케이션 같은 경우 ip,포트로 요청 주고 받는데 db가 공격받기 쉬움
  - 자원 확장(스케일아웃) 어려움: 클라이언트는 추가된 서버의 주소를 다 알아야 하니까

  

<img src="C:\Users\yujin\AppData\Roaming\Typora\typora-user-images\image-20201018135715387.png" alt="image-20201018135715387" style="zoom:50%;" />

- 서버 단위의 로드 밸런서

  - 장점 : 스케일 아웃이 가능해짐, 일부 서버에 장애 생겨도 다른 서버에 요청주면 됨

  - 단점 : 로드밸런서에 장애 생기면 전체 서비스 장애 

  - 로드밸런서 : l4 스위치

    

<img src="C:\Users\yujin\AppData\Roaming\Typora\typora-user-images\image-20201018140805443.png" alt="image-20201018140805443" style="zoom: 50%;" />

- 서버내 앱 단위의 로드 밸런서
  - 로드밸런서1 : 서버들에게 요청 분산(서버단위)
  - 로드밸런서2 :  애플리케이션들에게 요청 분산(앱단위)
  - 애플리케이션 서버 안에서 여러개 프로세스 만들면 , 하나의 서버에서 여러개 요청 동시 처리 가능 

##### AWS EC2 이용한 서버 인스턴스  생성 관리

- EC2 인스턴스 생성시 

  - AMI : 인스턴스 생성 위한 이미지

  - 보안 그룹 : IP, 포트 정의해두는 서버 접속 규칙

  - 키 페어: 서버는 퍼플릭키, 사용자는 개인키 들고 서버에 접속

    

##### 웹 서버와 웹 애플리케이션 서버

- 웹 서버 

  - 정적인 파일 응답 전달 (HTML, 이미지, CSS, JS)

  - nginx, apache

    

- 웹 애플리케이션 서버

  - 클라이언트 요청에 대해 코드 실행을 통한 동적 응답 전달

  - 배포한 코드를 프로세스로 실행, 해당 프로세스에 요청 넘겨줌

  - phusion passenger, apache tomcat

    

    

- 웹 서버, 웹 애플리케이션 서버 보통 함께 사용

  <img src="C:\Users\yujin\OneDrive\바탕 화면\KakaoTalk_20201018_162403804.jpg" alt="KakaoTalk_20201018_162403804" style="zoom:67%;" />

#### 3 다중 서버 환경 구성

##### AWS Auto Scailing 그룹

- AWS Auto Scailing : aws에서 제공하는 자동 다중 서비스

  - 같은 ec2 인스턴스들의 묶음

  - 인스턴스 수를 자동으로 늘리고 줄여줌

  - 자원 사용량/시간을 기준으로 자동 조정 

    

- ami 만드는데 사용된 인스턴스는 평상시 중지상태로 존재

- 변경사항 생길 시, 인스턴스 켜서 변경사항 반영하고 중지한뒤 ami, 시작 템플릿 생성 과정을 거쳐야 한다

- 즉, 새로운 코드 배포시 인스턴스 실행한 뒤 앞서 한 모든 작업 다시 해야

- 이런 불편함을 없애기 위해 -> 배포 자동화

  

##### AWS Elastric Load Balancing 을 이용한 서버 트랙픽 분산 관리

- elastic load balancing
  - 로드밸런서 역할 하는 aws 서비스

- 대상 그룹
  - 로드 밸런서가 요청을 전달할 서버의 묶음

#### 4 운영 서버의 외부 환경 구성

##### 도메인, DNS

- 도메인 주소 : IP 주소의 이름 ZZZ.com 같은..
- DNS : 도메인과 연결된 IP주소들을 관리하는 서버
- 도메인 주소의 작동 원리 
  - 웹브라우저에 ZZZ.com 입력 -> 웹브라우저와 가까운 dns 서버에 해당하는 ip 요청 -> ip 주소를 알고 있는 dns 서버를 찾으면 해당 ip 주소 반환 -> 웹 브라우저에서 ip주소를 이용해 서버에게 페이지 조회 요청

#### 5 배포 과정

##### 배포(deploy) 관련 용어

- Rolling

  ~~~~
  3: 버전 2와 1이 일시적으로 공전
  
  예상되는 문제 : 2, 4는 일시적으로 부하가 하나로 몰리는 문제
  하나의 인스턴스로 트래픽이 집중될 수 있음
  - 따라서 부하가 집중될 때 견딜 수 있는지 예측 필요
  - roll back(v2- > v1)에 많은 시간 소요될 수 있음
  
  ~~~~

  

  <img src="C:\Users\yujin\AppData\Roaming\Typora\typora-user-images\image-20201014093548770.png" alt="image-20201014093548770" style="zoom:67%;" />

- Blue/Green

  ~~~~
  - v1 구버전 v2 신버전
  - 구버전 신버전 동시에 서비스(주소 또는 포트번호로 구분)
  - 구버전에서 신버전으로 일제히 전화
  - 2번 까지는 roll-back 수월한 편
  - 단점 : 인스턴스를 많이 필요하기 때문에 비용이 커짐
  ~~~~

  <img src="C:\Users\yujin\AppData\Roaming\Typora\typora-user-images\image-20201014094129083.png" alt="image-20201014094129083" style="zoom:67%;" />

- canary

  ~~~
  - 위험을 빠르게 감지할 수 있는 배포 기법
  - 블루그린은 제한된 사람만 접속
  - 카나리는 구버전가 신버전 공존, 일 정 수량만 접속 할 수 있게,
  신버전에 문제 안생기면 신버전쪽으로 비율 높임
  - 실제 사용자 환경에서 발생할 수 있는 문제를 조금씩 계속 모니터링
  - 문제 발생시 위험이 높은 서비스에서 사용
  ~~~

  <img src="C:\Users\yujin\AppData\Roaming\Typora\typora-user-images\image-20201014095045879.png" alt="image-20201014095045879" style="zoom:67%;" />

##### 블루/그린 배포 실습

~~~~
1. 블루 오토스케일링 그룹 생성
2. 기존 버전의 코드 서비스 => 블루 오토스케일링을 로드 밸런서에 등록(대상그룹)

3. 새로운 버전의 코드 서비스 => 인스턴스를 실행 시키고 ssh 접속하여 최신 버전의 코드 받기
4. 인스턴스 중지되면 이미지 생성 , 이 이미지 이용한 새로운 템플릿 생성
5. 그린 오토스케일링 그룹 생성
6. 그린 오토스케일링을 로드 밸런서에 등록(대상그룹)
~~~~

#### 6 배포 자동화

##### IAM

~~~~
권한의 모임 -> 정책
AWS 기능과 자원 이용하는 객체 -> 사용자
여러 사용자에게 공통으로 권한 부여 -> 그룹
서비스나 다른 AWS 계정에 정책 적용, 권한 부여 -> 역할
EC2 인스턴스 구분하고  권한을 줌 -> 인스턴스 프로파일 
~~~~

##### Code Deploy 

- AWS에서 제공하는 배포 자동화 서비스

- 명령어 적어두고 프로그램이 그 명령을 순차적으로 실행

  ![image-20201018215620903](C:\Users\yujin\AppData\Roaming\Typora\typora-user-images\image-20201018215620903.png)

~~~~
1. 소스 코드를 깃헙이나 aws s3에 추가
2. codedeploy에 프로젝트 특정 버전을 배포해 달라고 요청
3. codedeploy는 ec2의 agent들과 통신하며 배포를 요청
4. agent드릉ㄴ 요청을 받아 코드 저장소에서 프로젝트 내려받고, 배포 진행
5. 배포 결과를 code deploy에게 알려줌
~~~~

##### codedeploy로 현재 위치 배포 진행

~~~~
1. 서비스 역할 생성 -> ec2 인스턴스에게 배포 진행시 권한 부여 위함
2. ami 생성용 ec2인스턴스에 codedeploy agent 설치, 환경 구성
3. ec2 인스턴스 이용하여 새로운 ami 생성
4. 시작 템플릿 이용해 auto scailing 그룹에 여러대의 인스턴스 실행하고 새로운 버전의 코드 배포

여기성 인스턴스란 . codedeploy 지원하는 인스턴스
~~~~

#### 비밀 값 관리 

##### 비밀 값 관리 원칙

- 비밀 값은 버전 관리 시스템에 업로드 x
- 비밀 값은 최소한의 인원만 알고 있다
- 비밀 값과 아닌 값은 분리해야 한다

##### blackox

- 비밀 값들을 담고 있는 파일을 암호화 해서 vcs에 올림 -> 이러한 오픈소스 툴로 blackbox
- GPG를 이용해 암호화, 복호화, 관리자 관리 등의 작업을 쉽게 이용할 수 있는 셸 스크립트의 모음
- GPG : 암호화 프로그램으로 비밀 값들이 담긴 파일들을 암호화

##### Vault

- 클라우드 인프라 자동화 제품을 만드는 hashicorp에서 만든 오픈소스 프로젝트
- 비밀 관리하는 데 필요한 모든 기능 제공

~~~~
키..

대칭키 ⇒ 암화화 키와 복호화 키가 동일
	⇒ 비밀키, 유일키, 관용 암호화 방식
	⇒ DES, 2DES, 3DES, AES, ARIA, SEED, … 

비대칭키 ⇒ 암호화 키와 복호화 키가 상이
	  ⇒ 개인키, 공개키 쌍으로 구성
 	  ⇒ 공개키 암호화 방식



보안강도 = 비도
 	  ⇒ 암호문으로 암호화에 사용된 키를 찾아내는데 걸리는 시도 회수
		예) 비도 128 = 2^128 만큼 시도해야 암호화에 사용된 키를 알아낼 수 있다.

                        암호화
             ------------------------------->

	평문  ----------> 알고리즘 ----------> 암호문
                            +
                           "키"
             <-------------------------------
                        복호화

~~~~

##### 실습 : secret manager 사용법 

~~~~
액세스키 id AKIA2VHGIJYDGAS6ZFUF
비밀 엑세스 키 srEf6jKDZ/tBw3jSGItnvs7l/vMNju82h6KuzYJ3

~~~~



~~~~
1  2  3  4  5  6  7  8  9  10
-----------------------------
1  1  4  4  4  3  1     2   
1  3  1  2  1           3   1 
3  1  2  3  1  1  1  3  3           

~~~~







#### **API Gateway Canary Release Deployment**

- api gateway 

  ~~~~
  api 개발자가 쉽게 api 만들고 , 게시 , 유지보수, 모니터링 할 수 있도록 하는 서비스
  
  람다 뿐 아니라 ec2 등 여러 서비스를 직접 연결하는 api 게이트웨이 이용해서 구축한 서비스  사용할 수 있도록 도와줌
  ~~~~

  ![image-20201014101508421](C:\Users\yujin\AppData\Roaming\Typora\typora-user-images\image-20201014101508421.png)

- MATH.CEIL 함수

  ~~~
  console.log('Loading Lambda function');
  # 호출 내용
  exports.handler = async (event, context, callback) => {
      let resultNum = Math.ceil(999.99); #999.99올림한 값을 출력
      # 이런 문자열 리턴한다
      callback(null, 'this is the original function (Math.ceil) = ' + resultNum);
  };
  ~~~

  

- url 호출 : 람다함수 실행되고 반환하여 보여짐

- 루트로 요청 들어오면 게이트웨이가 람다1번 쪽으로 가게 만들어놨는데

- 람다 2번으로도 갈 수있도록 하고 싶음

~~~~
지금까지,

serverless 
- lambda
- api gw -> canary deployment함
~~~~

#### **Deploying a Basic Infrastructure Using CloudFormation Templates**

- cloudformation : infrastructure code를 통해 손쉽게 리소스 모음을 모델링하고 , 간단히 프로비저닝, 수명 주기 전반에 걸쳐 관리 가능

- 한마디로, infrastructure as code로 클라우드 프로비저닝 가속화
- infrastructure as code : 인프라를 코드 형태로 관리 할 수 있다..

- 키페어 생성 : ec2 인스턴스 스크립트화한 코드 이용, 그리고 ec2에 접속하려면 키페어 필요하니까
- 그래서 우리는, 깃의 변화(코드)를 클라우드가 감지해서 자동으로 인프라 생성하는 것을 도와주는게 - 클라우드포메이션 

![image-20201014120258584](C:\Users\yujin\AppData\Roaming\Typora\typora-user-images\image-20201014120258584.png)

- 우리는 코드를 보는게 중요하다! 

### 오늘 수업 책 12Xx 페이지까지 근데 못따라가서 나중에 다시하기

- 하나의 템플릿으로 오토스케일링 가능하고 (노드밸런싱 가능?) 

![image-20201014165054009](C:\Users\yujin\AppData\Roaming\Typora\typora-user-images\image-20201014165054009.png)

- ----------디플로이하는과정 --------------버전체인지

- 나중에 삭제할때 오토스케일링 용량 000으로 만들기

- 이렇게 하면 인스턴스 내리는 꼴 

  